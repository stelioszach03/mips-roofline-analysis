# Πολλαπλασιασμός τετραγωνικού πίνακα με βαθμωτό (n=16)
# Υλοποίηση για QtMips με βασικές εντολές

.data
    # Πίνακας εισόδου 16x16
    matrix:
    # Γραμμές 1-8
    .word 1:16, 2:16, 3:16, 4:16, 5:16, 6:16, 7:16, 8:16
    # Γραμμές 9-16
    .word 9:16, 10:16, 11:16, 12:16, 13:16, 14:16, 15:16, 16:16

    # Βαθμωτός αριθμός
    scalar: .word 2

    # Πίνακας αποτελέσματος 16x16
    result: .word 0:256    # 256 μηδενικά (16x16)

.text
.globl __start
__start:
    # Αρχικοποίηση μετρητών και διευθύνσεων
    addiu $8, $0, 0        # i = 0 (γραμμή)
    addiu $9, $0, 0        # j = 0 (στήλη)
    addiu $10, $0, 16      # όριο = 16
    lui $1, 0x1000         # Βάση διεύθυνσης δεδομένων
    lw $11, 1024($1)       # Φόρτωση βαθμωτού

outer_loop:
    beq $8, $10, done      # Εάν i = όριο, τέλος
    nop                    # Καθυστέρηση διακλάδωσης

    addiu $9, $0, 0        # j = 0

inner_loop:
    beq $9, $10, next_row  # Εάν j = όριο, επόμενη γραμμή
    nop                    # Καθυστέρηση διακλάδωσης

    # Υπολογισμός διεύθυνσης στοιχείου matrix[i][j]
    sll $5, $8, 6          # i * 64 (16 words * 4 bytes)
    sll $6, $9, 2          # j * 4 (1 word)
    addu $7, $5, $6        # Συνολική μετατόπιση
    addu $12, $1, $7       # Διεύθυνση στοιχείου
    lw $13, 0($12)         # Φόρτωση στοιχείου

    # Πολλαπλασιασμός με προσθέσεις
    addiu $14, $0, 0       # αποτέλεσμα = 0
    addiu $15, $0, 0       # μετρητής επαναλήψεων
    addu $16, $0, $11      # αντίγραφο πολλαπλασιαστή

mult_loop:
    beq $15, $16, store_result  # Εάν τέλος πολλαπλασιασμού
    nop                         # Καθυστέρηση διακλάδωσης

    # Έλεγχος υπερχείλισης
    addu $17, $14, $13     # Δοκιμαστική πρόσθεση
    sltu $18, $17, $14     # Έλεγχος υπερχείλισης
    bne $18, $0, overflow_handler
    nop                    # Καθυστέρηση διακλάδωσης

    addu $14, $14, $13     # αποτέλεσμα += στοιχείο
    addiu $15, $15, 1      # μετρητής++
    j mult_loop
    nop                    # Καθυστέρηση άλματος

store_result:
    addiu $19, $12, 1028   # Διεύθυνση αποτελέσματος
    sw $14, 0($19)         # Αποθήκευση αποτελέσματος
    addiu $9, $9, 1        # j++
    j inner_loop
    nop                    # Καθυστέρηση άλματος

next_row:
    addiu $8, $8, 1        # i++
    j outer_loop
    nop                    # Καθυστέρηση άλματος

overflow_handler:
    j overflow_handler     # Ατέρμων βρόχος σε περίπτωση υπερχείλισης
    nop                    # Καθυστέρηση άλματος

done:
    j done                 # Ατέρμων βρόχος για κανονικό τερματισμό
    nop                    # Καθυστέρηση άλματος
